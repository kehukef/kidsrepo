# Msummary.hs のプログラム仕様
---
## プログラム概要：マスタデータから指定された年月の月間明細HTMLを作成する。
### 第一引数：年月(YYYY/MM)
### 第二引数：マスタデータファイル(フルパス)
### 出力    ：HTMLデータ(文字列)  
  
出力するHTMLの構造は
```
<div class="nobreak">
  <table>
    １人分の明細
  </table>
  <table>
    １人分の明細
  </table>
  .
  .
  .
  <table>
    １人分の明細
  </table>
</div>
<div class="nobreak">
  <table>
  .
  .
  .
</div>
以下同様
```
外側のdivがA4１ページ分のデータを格納するボックスになっていて、その中に納まるだけのテーブルを詰める。
全ページ分出来上がったら、HTML文字列をプログラム呼び出し元に返す。  
---  

## 作成方針：
## マスタデータから処理対象のデータを絞りつつ、処理しやすい並びに変える
まず、マスタデータのフォーマットは
```
|1          |2        |3     |4    |5   |6   |7   |8   |9   |10  |11  |12  |
|:--        |:--      |:--   |:--  |:-- |:-- |:-- |:-- |:-- |:-- |:-- |:-- |
|yyyy/mm/dd |memberid |class |name |smf |smt |sef |set |amf |amt |aef |aet |
|yyyy/mm/dd |memberid |class |name |smf |smt |sef |set |amf |amt |aef |aet |
.
.
.
|yyyy/mm/dd |memberid |class |name |smf |smt |sef |set |amf |amt |aef |aet |
```
これを入力として実績があるデータの同一memberidごとのリストが複数格納された以下のリストをまず作成する
```
※amf = Actual Morning From
  amt = Actual Morning To
  aef = Actual Evening From
  aet = Actual Evening To
[ 
  -- 1人目
  [
    ["201701001", "2017/12/01", "class", "name", "amf", "amt", "dftime", "amount"] 
   ,["201701001", "2017/12/02", "class", "name", "aef", "aet", "dftime", "amount"]
   ...
   ,["201701001", "2017/12/30", "class", "name", "aef", "aet", "dftime", "amount"]
  ],
  -- 2人目
  [
    ["201701002", "2017/12/01", "class", "name", "amf", "amt", "dftime", "amount"] 
   ,["201701002", "2017/12/04", "class", "name", "aef", "aet", "dftime", "amount"]
    ...
   ,["201701002", "2017/12/30", "class", "name", "aef", "aet", "dftime", "amount"]
  ],
  .
  .
  .
  -- 最後
  [
    ["201703013", "2017/12/02", "class", "name", "amf", "amt", "dftime", "amount"] 
   ,["201703013", "2017/12/02", "class", "name", "aef", "aet", "dftime", "amount"]
    ...
   ,["201703013", "2017/12/25", "class", "name", "aef", "aet", "dftime", "amount"]
  ]
]
```
これをtlinesとする。これは入力を以下のようにすれば得られる。
  1. 年月と実績ありで`filter`したデータを、
  2. メンバーIDで`sortBy`して、
  3. AMとPMの実績を別レコードに分離する。(このときにdftimeとamountも計算して付与する)
  4. メンバーIDが一致するかどうかで`groupBy`によりグループ分け。

## tlinesから以下のようにして1ページごとのHTMLを作成する。

1メンバーのデータはひとつのリストに収まっているので、リストの要素数が明細データの数と一致する。
なので、リストの要素数からそのメンバーのテーブルの高さが計算できる。
A4の高さにあわせたピクセル1000pxからその高さを引いて、残った高さから次のメンバーの高さを同様にして引いていく。

でA4の高さを超えた段階で、そのページに何人分のテーブルが収まるのかが決まる。
(ただし、縦２段にわたって段組しているのでそこは考慮して計算する。)

たとえば、各メンバーの要素数が
[300, 200, 400, 600, 800, 600, 300]
だったとすると、
1000 - 300
700  - 200
500  - 400
100  - 600
↑ここでA4の高さをオーバーするので、A4の左半分に収まるテーブル数は3つとわかる。
次に右半分に収まるテーブル数を調べる
1000 - 600
400  - 800
↑ここでA4の高さをオーバーするので、右半分に収まるテーブル数は1つとわかる。
以上より、1ページ目に格納できるテーブルの合計は先頭から4つとわかる。  
  
先頭4つを除いた残りのリストに対して同様にすれば、次のページに収まるテーブル数を割り出せる。
すると以下のようになる
1ページ目
----------------------------------
|  |---------|     |---------|   |
|  |   300   |     |  600    |   |
|  |         |     |         |   |
|  |         |     |         |   |
|  |---------|     |         |   |
|  |   200   |     |         |   |
|  |         |     |         |   |
|  |---------|     |---------|   |
|  |   400   |                   |
|  |         |                   |
|  |         |                   |
|  |         |                   |
|  |---------|                   |
----------------------------------

2ページ目
----------------------------------
|  |---------|     |---------|   |
|  |   800   |     |  600    |   |
|  |         |     |         |   |
|  |         |     |         |   |
|  |         |     |         |   |
|  |         |     |         |   |
|  |         |     |         |   |
|  |         |     |---------|   |
|  |         |     |  300    |   |
|  |---------|     |         |   |
|                  |         |   |
|                  |---------|   |
|                                |
----------------------------------

...

ページをあらわすdivに対して、改ページ禁止、flowを指定する。
